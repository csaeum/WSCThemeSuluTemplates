{#
    Block: wsc-table
    Flexible HTML-Tabelle mit automatischer Normalisierung auf Header-Spaltenanzahl
#}

{% set headerCells = block.header_cells|default([]) %}
{% set bodyRows = block.body_rows|default([]) %}

{# Layout #}
{% set tableStyle = block.table_style|default([]) %}
{% set tableColor = block.table_color|default('') %}
{% set responsive = block.responsive|default(true) %}
{% set allowHtml = block.allow_html|default(false) %}
{% set headerDark = block.header_dark|default(false) %}
{% set caption = block.caption|default('') %}

{# Margin #}
{% set marginTop = block.margin_top|default('mt-3') %}
{% set marginBottom = block.margin_bottom|default('mb-3') %}
{% set marginStart = block.margin_start|default('ms-0') %}
{% set marginEnd = block.margin_end|default('me-0') %}

{# Padding #}
{% set paddingTop = block.padding_top|default('pt-0') %}
{% set paddingBottom = block.padding_bottom|default('pb-0') %}
{% set paddingStart = block.padding_start|default('ps-0') %}
{% set paddingEnd = block.padding_end|default('pe-0') %}

{# Erweiterte Optionen #}
{% set cssClass = block.css_class|default('') %}
{% set htmlId = block.html_id|default('') %}

{# WICHTIG: Spaltenanzahl aus Header ermitteln - Header ist f체hrend! #}
{% set columnCount = headerCells|length %}

{# Wrapper-Klassen zusammenstellen #}
{% set wrapperClasses = [] %}
{% if marginTop != 'mt-0' %}{% set wrapperClasses = wrapperClasses|merge([marginTop]) %}{% endif %}
{% if marginBottom != 'mb-0' %}{% set wrapperClasses = wrapperClasses|merge([marginBottom]) %}{% endif %}
{% if marginStart != 'ms-0' %}{% set wrapperClasses = wrapperClasses|merge([marginStart]) %}{% endif %}
{% if marginEnd != 'me-0' %}{% set wrapperClasses = wrapperClasses|merge([marginEnd]) %}{% endif %}
{% if paddingTop != 'pt-0' %}{% set wrapperClasses = wrapperClasses|merge([paddingTop]) %}{% endif %}
{% if paddingBottom != 'pb-0' %}{% set wrapperClasses = wrapperClasses|merge([paddingBottom]) %}{% endif %}
{% if paddingStart != 'ps-0' %}{% set wrapperClasses = wrapperClasses|merge([paddingStart]) %}{% endif %}
{% if paddingEnd != 'pe-0' %}{% set wrapperClasses = wrapperClasses|merge([paddingEnd]) %}{% endif %}
{% if cssClass is not empty %}{% set wrapperClasses = wrapperClasses|merge([cssClass]) %}{% endif %}

{# Table-Klassen zusammenstellen #}
{% set tableClasses = ['table'] %}
{% if tableStyle is iterable %}
    {% for style in tableStyle %}
        {% set tableClasses = tableClasses|merge([style]) %}
    {% endfor %}
{% endif %}
{% if tableColor is not empty %}
    {% set tableClasses = tableClasses|merge([tableColor]) %}
{% endif %}

{# Header-Klassen #}
{% set theadClasses = [] %}
{% if headerDark %}
    {% set theadClasses = theadClasses|merge(['table-dark']) %}
{% endif %}

{# Finale Klassen-Strings #}
{% set wrapperClassString = wrapperClasses|join(' ') %}
{% set tableClassString = tableClasses|join(' ') %}
{% set theadClassString = theadClasses|join(' ') %}

{% if columnCount > 0 %}
<div{% if htmlId %} id="{{ htmlId }}"{% endif %}{% if wrapperClassString %} class="{{ wrapperClassString }}"{% endif %}>
    {% if responsive %}
    <div class="table-responsive">
    {% endif %}

        <table class="{{ tableClassString }}">
            {# Optionale Caption #}
            {% if caption is not empty %}
            <caption>{{ caption }}</caption>
            {% endif %}

            {# Header #}
            <thead{% if theadClassString %} class="{{ theadClassString }}"{% endif %}>
                <tr>
                    {% for headerCell in headerCells %}
                        {% set cellContent = headerCell.content|default('') %}
                        {% set cellAlign = headerCell.align|default('start') %}
                        {% set alignClass = cellAlign != 'start' ? 'text-' ~ cellAlign : '' %}

                        <th{% if alignClass %} class="{{ alignClass }}"{% endif %}>
                            {% if allowHtml %}
                                {{ cellContent|raw }}
                            {% else %}
                                {{ cellContent|nl2br }}
                            {% endif %}
                        </th>
                    {% endfor %}
                </tr>
            </thead>

            {# Body #}
            <tbody>
                {% for row in bodyRows %}
                    {% set rowCells = row.cells|default([]) %}
                    {% set rowColor = row.row_color|default('') %}
                    {% set rowCssClass = row.row_css_class|default('') %}

                    {# Zeilen-Klassen #}
                    {% set rowClasses = [] %}
                    {% if rowColor is not empty %}
                        {% set rowClasses = rowClasses|merge([rowColor]) %}
                    {% endif %}
                    {% if rowCssClass is not empty %}
                        {% set rowClasses = rowClasses|merge([rowCssClass]) %}
                    {% endif %}
                    {% set rowClassString = rowClasses|join(' ') %}

                    <tr{% if rowClassString %} class="{{ rowClassString }}"{% endif %}>
                        {#
                            WICHTIG: Hier passiert die Normalisierung!
                            Wir iterieren 체ber die Spaltenanzahl vom Header (columnCount)
                            und nicht 체ber die tats채chlichen Zellen der Zeile
                        #}
                        {% for i in 0..(columnCount - 1) %}
                            {% set cell = rowCells[i]|default(null) %}
                            {% set cellContent = cell ? (cell.content|default('')) : '' %}
                            {% set cellAlign = cell ? (cell.align|default('start')) : 'start' %}
                            {% set alignClass = cellAlign != 'start' ? 'text-' ~ cellAlign : '' %}

                            <td{% if alignClass %} class="{{ alignClass }}"{% endif %}>
                                {% if cellContent is not empty %}
                                    {% if allowHtml %}
                                        {{ cellContent|raw }}
                                    {% else %}
                                        {{ cellContent|nl2br }}
                                    {% endif %}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    {% if responsive %}
    </div>
    {% endif %}
</div>
{% endif %}
